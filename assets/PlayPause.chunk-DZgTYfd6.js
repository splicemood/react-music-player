import{r as s,j as o,T as Ee}from"./index-Byx8sr5T.js";import{u as Le,f as a,d as Ae,L as l,t as je,s as L,o as Me,P as we,b as Ne,c as Ve,a as $,p as De,e as Be,g as Re,h as He,i as Ue,S as F,B as _e,H as qe,j as Ge,C as Oe,q as Qe,l as Ye,m as ze,n as Ke,T as $e}from"./Layout-CvFbaZEl.js";const d=window.localStorage,Fe=({children:A})=>{var K;const[m,P]=Le(void 0,Ne),[u,I]=s.useState([]),[j,S]=s.useState([]),[M,w]=s.useState(""),[c,f]=s.useState(a),[i,n]=s.useState(!1),[p,N]=s.useState(a),[V,D]=s.useState(0),_=d.getItem("player-volume"),J=_?Number(_):Ve,[v,W]=s.useState(J),[X,Z]=s.useState(Ae),[ee,k]=s.useState(a),[te,se]=s.useState(a),re=d.getItem("player-muted")==="true",[x,B]=s.useState(re),ne=d.getItem("player-shuffle")==="true",[g,R]=s.useState(ne),ae=d.getItem("player-repeat"),[H,ue]=s.useState(Number(ae)||l.PlayAll),[q,T]=s.useState([]),t=s.useRef(new Audio),b=s.useRef(null),ce=s.useCallback((e,r)=>{b.current&&b.current.postMessage({type:e,value:r})},[b.current]);s.useEffect(()=>{i&&T(g?e=>[c,...e]:[]),d.setItem("player-shuffle",String(g))},[g]),s.useEffect(()=>{const e=Math.round(v*100);Z(e)},[v]),s.useEffect(()=>{t.current!==null&&(t.current.currentTime=V,N(V))},[V]),s.useEffect(()=>{if(t.current&&u.length>a){const e=u[c];t.current.src=e==null?void 0:e.src,t.current.currentTime=a}},[u,c]),s.useEffect(()=>{t.current&&u.length>a&&(i?(ce("PAUSE_PLAYING"),P(!0),t.current.play().then(()=>{P(void 0)}).catch(()=>{P(void 0)})):t.current.pause())},[c,u,i]),s.useEffect(()=>{t.current&&(t.current.volume=v,t.current.muted=x)},[v,x]);const oe=e=>{const r=Array(e.length).fill(0);if(S(r),e.length>0){const h=e.map(y=>y.src);$(h).then(y=>{Array.isArray(y)&&S(y)})}},le=e=>{$([e.src]).then(r=>{r&&S(h=>[...h,r[0]])})},G=s.useCallback(()=>{t.current!==null&&se(t.current.duration)},[(K=t.current)==null?void 0:K.duration]),ie=s.useCallback(()=>{u.length!==a&&n(!0)},[u]),O=s.useCallback(()=>n(!1),[n]),de=s.useCallback(()=>n(e=>!e),[n]),E=s.useCallback((e=!1)=>{if(u.length===a)return;let r;if(g){const y=u.map((C,ke)=>ke).filter(C=>C!==c);r=y[Math.floor(Math.random()*y.length)],T(C=>(C=C.slice(a,je),[r,...C]))}else r=c+L;r>=u.length&&(n(e),r=a,!e)||(k(a),i||n(!0),f(r))},[u,c,g,i,f]),U=s.useCallback(()=>{var e;switch(H){case l.PlayAll:E();break;case l.LoopAll:E(!0);break;case l.LoopCue:(e=t.current)==null||e.play();break}},[H,E]),fe=s.useCallback(()=>{if(u.length===a||!t.current)return;if(p>Me){t.current.currentTime=a;return}let e=a;if(g){if(q.length===L)return;T(r=>{const[,...h]=r;return e=h[a],h})}else e=c-L;e<a&&(e=u.length-L),f(e),k(a),n(!0)},[u,q,c,p,D]),me=e=>f(e),Q=e=>{W(e),d.setItem("player-volume",String(e))},pe=e=>{const r=De(e);Q(r)},ge=()=>B(!0),he=()=>B(!1),ye=()=>B(e=>!e),Pe=()=>R(!0),Se=()=>R(!1),ve=()=>R(e=>!e),xe=()=>{ue(e=>{let r=l.PlayAll;return e===l.PlayAll&&(r=l.LoopAll),e===l.LoopAll&&(r=l.LoopCue),e===l.LoopCue&&(r=l.PlayAll),d.setItem("player-repeat",String(r)),r})},be=e=>{I(r=>[...r,e]),le(e)},Ce=e=>{O(),T([a]),k(a),I(e),f(a),oe(e)};s.useEffect(()=>{d.setItem("player-muted",String(x))},[x]);const Te=s.useCallback(e=>{const{data:r}=e;switch(r==null?void 0:r.type){case"PAUSE_PLAYING":n(!1);break}},[i,f,n,c]),Y=()=>{if(t.current&&t.current.buffered.length>0){const e=t.current.buffered.end(t.current.buffered.length-1);k(e/t.current.duration*100)}},z=()=>{if(t.current!==null){const e=t.current.currentTime;N(e),d.setItem("player-sync-time",String(e))}};s.useEffect(()=>(t.current&&t.current.addEventListener("ended",U),()=>{var e;(e=t.current)==null||e.removeEventListener("ended",U)}),[U]),s.useEffect(()=>{if(t.current){const e=d.getItem("player-sync-time"),r=Number(e);D(r),t.current.currentTime=r,t.current.muted=x,t.current.volume=v,N(r),n(!1),t.current.preload="metadata","BroadcastChannel"in window&&!b.current&&(b.current=new BroadcastChannel("playpause-audio-player"),b.current.onmessage=Te),t.current.addEventListener("progress",Y),t.current.addEventListener("timeupdate",z),t.current.addEventListener("durationchange",G)}return()=>{t.current&&(t.current.pause(),t.current.removeEventListener("progress",Y),t.current.removeEventListener("timeupdate",z),t.current.removeEventListener("durationchange",G),t.current=null)}},[]);const Ie={play:ie,pause:O,togglePlayPause:de,next:E,previous:fe,setVolume:Q,setVolumePercent:pe,mute:ge,unmute:he,toggleMute:ye,shuffleOn:Pe,shuffleOff:Se,toggleShuffle:ve,toggleLoop:xe,addToPlaylist:be,replacePlaylist:Ce,setCurrentTrack:me,setUpdateTime:D,setPlaylistId:w,volume:v,volumePercent:X,bufferedPercentage:ee,currentPlaylistId:M,maxTime:te,playlist:u,durations:j,isPlaying:i,currentTime:p,currentTrackIndex:c,repeatMode:H,isShuffled:g,isLoading:m,isMuted:x};return o.jsx(we.Provider,{value:Ie,children:A})},Je=()=>{const A=Be(),[m,P]=s.useState(1),[u,{open:I,close:j}]=Re(!1),[S,M]=s.useState("preview"),w=n=>{fetch(`tracks_${n}.json`).then(p=>p.json()).then(p=>{A.replacePlaylist(p)})},c=o.jsx($e,{size:18});s.useEffect(()=>{w(m)},[m]);const f=s.useCallback(()=>{let n=m+1;n>3&&(n=1),P(n)},[m]),i=s.useCallback(()=>{let n=m-1;n<1&&(n=3),P(n)},[m]);return He([["alt+ArrowLeft",i],["alt+ArrowRight",f],["mod+Slash",I]]),o.jsx(Ue,{children:o.jsxs(F,{gap:"xs",children:[o.jsxs(F,{children:[o.jsx(_e,{}),o.jsx(Ee,{order:2,children:"Play/Pause Sync Demo"})]}),o.jsx(qe,{opened:u,close:j}),S==="preview"?o.jsx(Ge,{nextPlaylist:f,prevPlaylist:i}):o.jsx(Oe,{code:[{fileName:"main.tsx",code:Qe,language:"tsx",icon:c},{fileName:"App.tsx",code:Ye,language:"tsx",icon:c}]}),o.jsx(ze,{value:S,onChange:M}),o.jsx(Ke,{})]})})},Ze=()=>o.jsx(Fe,{children:o.jsx(Je,{})});export{Ze as default};
