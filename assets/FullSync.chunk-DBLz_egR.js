import{r as t,j as m,T as Le}from"./index-Byx8sr5T.js";import{u as Ne,f as u,d as je,L as P,a as G,t as Me,s as U,o as Ve,P as De,b as Be,c as Fe,p as Re,e as Ue,g as _e,h as He,i as Oe,S as te,B as Je,H as Ke,j as qe,C as ze,k as Ge,l as Qe,m as Ye,n as $e,T as We}from"./Layout-CvFbaZEl.js";function re(a,h,g){t.useEffect(()=>(window.addEventListener(a,h,g),()=>window.removeEventListener(a,h,g)),[a,h])}function Xe(a,h="use-local-storage"){try{return JSON.stringify(a)}catch{throw new Error(`@mantine/hooks ${h}: Failed to serialize the value`)}}function Ze(a){try{return a&&JSON.parse(a)}catch{return a}}function et(a){return{getItem:f=>{try{return window[a].getItem(f)}catch{return console.warn("use-local-storage: Failed to get value from storage, localStorage is blocked"),null}},setItem:(f,o)=>{try{window[a].setItem(f,o)}catch{console.warn("use-local-storage: Failed to set value to storage, localStorage is blocked")}},removeItem:f=>{try{window[a].removeItem(f)}catch{console.warn("use-local-storage: Failed to remove value from storage, localStorage is blocked")}}}}function tt(a,h){const g="mantine-local-storage",{getItem:A,setItem:f,removeItem:o}=et(a);return function({key:l,defaultValue:d,getInitialValueInEffect:M=!0,deserialize:w=Ze,serialize:T=i=>Xe(i,h)}){const i=t.useCallback(s=>{let S;try{S=typeof window>"u"||!(a in window)||window[a]===null||!!s}catch{S=!0}if(S)return d;const I=A(l);return I!==null?w(I):d},[l,d]),[b,c]=t.useState(i(M)),y=t.useCallback(s=>{s instanceof Function?c(S=>{const I=s(S);return f(l,T(I)),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:s(S)}})),I}):(f(l,T(s)),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:s}})),c(s))},[l]),v=t.useCallback(()=>{o(l),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:d}}))},[]);return re("storage",s=>{s.storageArea===window[a]&&s.key===l&&c(w(s.newValue??void 0))}),re(g,s=>{s.detail.key===l&&c(s.detail.value)}),t.useEffect(()=>{d!==void 0&&b===void 0&&y(d)},[d,b,y]),t.useEffect(()=>{const s=i();s!==void 0&&y(s)},[]),[b===void 0?d:b,y,v]}}function x(a){return tt("localStorage","use-local-storage")(a)}const C=window.localStorage,rt=({children:a})=>{var ee;const[h,g]=t.useState(!1),[A,f]=Ne(void 0,Be),[o,p]=t.useState([]),[l,d]=t.useState([]),M=C.getItem("player-playlist-id"),[w,T]=x({key:"player-playlist-id",defaultValue:M||void 0}),i=C.getItem("player-current-track-index"),b=i?Number(i):u,[c,y]=t.useState(b),[v,s]=t.useState(!1),[S,I]=t.useState(u),[V,_]=x({key:"player-updated-time",defaultValue:0,getInitialValueInEffect:!0}),[D,Q]=x({key:"player-volume",defaultValue:Fe,getInitialValueInEffect:!0}),[ne,se]=t.useState(je),[ae,F]=t.useState(u),[oe,ue]=t.useState(u),[H,O]=x({key:"player-muted",defaultValue:!1}),[L,J]=x({key:"player-shuffle",defaultValue:!1}),[K,ce]=x({key:"player-repeat",defaultValue:P.PlayAll}),[Y,B]=x({key:"player-shuffle-queue",defaultValue:[]}),r=t.useRef(new Audio),N=t.useRef(null),q=t.useCallback((e,n)=>{N.current&&N.current.postMessage({type:e,value:n})},[N.current]);t.useEffect(()=>{q("UPDATE_TRACK",c)},[c]),t.useEffect(()=>{v&&B(L?e=>[c,...e]:[])},[L]),t.useEffect(()=>{const e=Math.round(D*100);se(e)},[D]),t.useEffect(()=>{if(r.current!==null&&h){const e=r.current.currentTime;Math.abs(e-V)>1&&(r.current.currentTime=V,I(V))}},[V]),t.useEffect(()=>{if(r.current&&o.length>u){const e=o[c];r.current.src=e==null?void 0:e.src,r.current.currentTime=u}},[o,c]),t.useEffect(()=>{if(r.current&&o.length>u){const e=C.getItem("player-current-track-index"),n=e&&Number(e)===c;n||C.setItem("player-current-track-index",String(c)),v?(q("PAUSE_PLAYING"),f(!0),r.current.play().then(()=>{if(r.current&&n){const E=C.getItem("player-sync-time");r.current.currentTime=Number(E)}f(void 0)}).catch(()=>{f(void 0)})):r.current.pause()}},[c,o,v]),t.useEffect(()=>{r.current&&(r.current.volume=D,r.current.muted=H)},[D,H]);const le=e=>{const n=Array(e.length).fill(0);if(d(n),e.length>0){const E=e.map(k=>k.src);G(E).then(k=>{Array.isArray(k)&&d(k)})}},ie=e=>{G([e.src]).then(n=>{n&&d(E=>[...E,n[0]])})},de=e=>{String(e)!==w&&(y(u),T(e))};t.useEffect(()=>{if(o.length>0){const e=o.map(n=>n.src);G(e).then(n=>{Array.isArray(n)&&d(n)})}},[o]);const $=()=>{if(r.current!==null){const e=r.current.currentTime;I(e),q("UPDATE_TIME",e),C.setItem("player-sync-time",String(e))}},W=t.useCallback(()=>{r.current!==null&&ue(r.current.duration)},[(ee=r.current)==null?void 0:ee.duration]),fe=t.useCallback(()=>{o.length!==u&&s(!0)},[o]),X=t.useCallback(()=>s(!1),[s]),me=t.useCallback(()=>s(e=>!e),[s]),R=t.useCallback((e=!1)=>{if(o.length===u)return;let n;if(L){const k=o.map((j,Ae)=>Ae).filter(j=>j!==c);n=k[Math.floor(Math.random()*k.length)],B(j=>(j=j.slice(u,Me),[n,...j]))}else n=c+U;n>=o.length&&(s(e),n=u,!e)||(F(u),v||s(!0),y(n))},[o,c,L,v,y]),z=t.useCallback(()=>{var e;switch(K){case P.PlayAll:R();break;case P.LoopAll:R(!0);break;case P.LoopCue:(e=r.current)==null||e.play();break}},[K,R]),ge=t.useCallback(()=>{if(o.length===u||!r.current)return;if(S>Ve){r.current.currentTime=u;return}let e=u;if(L){if(Y.length===U)return;B(n=>{const[,...E]=n;return e=E[u],E})}else e=c-U;e<u&&(e=o.length-U),y(e),F(u),s(!0)},[o,Y,c,S,_]),he=e=>y(e),pe=e=>Q(e),ye=e=>{const n=Re(e);Q(n)},ve=()=>O(!0),Pe=()=>O(!1),Se=()=>O(e=>!e),Ie=()=>J(!0),Ee=()=>J(!1),we=()=>J(e=>!e),be=()=>{ce(e=>e===P.PlayAll?P.LoopAll:e===P.LoopAll?P.LoopCue:e===P.LoopCue?P.PlayAll:P.PlayAll)},Te=e=>{p(n=>[...n,e]),ie(e)},ke=e=>{X(),B([u]),F(u),p(e),le(e)},xe=t.useCallback(e=>{const{data:n}=e;switch(n==null?void 0:n.type){case"PAUSE_PLAYING":s(!1);break;case"UPDATE_TIME":!v&&n.value!==u&&I(n.value);break;case"UPDATE_TRACK":v||y(n.value);break}},[v,y,s,c]),Z=()=>{if(r.current&&r.current.buffered.length>0){const e=r.current.buffered.end(r.current.buffered.length-1);F(e/r.current.duration*100)}};t.useEffect(()=>(r.current&&r.current.addEventListener("ended",z),()=>{var e;(e=r.current)==null||e.removeEventListener("ended",z)}),[z]),t.useEffect(()=>{if(r.current){const e=C.getItem("player-sync-time"),n=Number(e);_(n),r.current.currentTime=n,I(n),s(!1),r.current.preload="metadata",r.current.addEventListener("progress",Z),r.current.addEventListener("timeupdate",$),r.current.addEventListener("durationchange",W),g(!0)}return"BroadcastChannel"in window&&!N.current&&(N.current=new BroadcastChannel("global-audio-player"),N.current.onmessage=xe),()=>{r.current&&(r.current.pause(),r.current.removeEventListener("progress",Z),r.current.removeEventListener("timeupdate",$),r.current.removeEventListener("durationchange",W),r.current=null)}},[]);const Ce={play:fe,pause:X,togglePlayPause:me,next:R,previous:ge,setVolume:pe,setVolumePercent:ye,mute:ve,unmute:Pe,toggleMute:Se,shuffleOn:Ie,shuffleOff:Ee,toggleShuffle:we,toggleLoop:be,addToPlaylist:Te,replacePlaylist:ke,setCurrentTrack:he,setUpdateTime:_,setPlaylistId:de,volume:D,volumePercent:ne,bufferedPercentage:ae,currentPlaylistId:w,maxTime:oe,playlist:o,durations:l,isPlaying:v,currentTime:S,currentTrackIndex:c,repeatMode:K,isShuffled:L,isLoading:A,isMuted:H};return m.jsx(De.Provider,{value:Ce,children:a})},nt=()=>{const a=Ue(),[h,{open:g,close:A}]=_e(!1),[f,o]=t.useState("preview"),[p,l]=t.useState(Number(a.currentPlaylistId)||1),d=m.jsx(We,{size:18}),M=i=>{fetch(`tracks_${i}.json`).then(b=>b.json()).then(a.replacePlaylist)};t.useEffect(()=>{M(p),a.setPlaylistId(p)},[p]),t.useEffect(()=>{a.currentPlaylistId&&l(Number(a.currentPlaylistId))},[a.currentPlaylistId]);const w=t.useCallback(()=>{let i=p+1;i>3&&(i=1),l(i)},[p]),T=t.useCallback(()=>{let i=p-1;i<1&&(i=3),l(i)},[p]);return He([["alt+ArrowLeft",T],["alt+ArrowRight",w],["mod+Slash",g]]),m.jsx(Oe,{children:m.jsxs(te,{gap:"xs",children:[m.jsxs(te,{children:[m.jsx(Je,{}),m.jsx(Le,{order:2,children:"Full Sync Demo"})]}),m.jsx(Ke,{opened:h,close:A}),f==="preview"?m.jsx(qe,{nextPlaylist:w,prevPlaylist:T}):m.jsx(ze,{code:[{fileName:"main.tsx",code:Ge,language:"tsx",icon:d},{fileName:"App.tsx",code:Qe,language:"tsx",icon:d}]}),m.jsx(Ye,{value:f,onChange:o}),m.jsx($e,{})]})})},ot=()=>m.jsx(rt,{children:m.jsx(nt,{})});export{ot as default};
