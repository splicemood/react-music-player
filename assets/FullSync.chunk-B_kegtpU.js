import{r as t,j as m,T as Le}from"./index-B901UW0W.js";import{u as Ne,f as u,d as je,L as P,a as z,t as Me,s as U,o as Ve,P as De,b as Be,c as Re,p as Ue,e as _e,g as Fe,h as He,i as Oe,S as re,B as Je,H as Ke,j as qe,C as ze,k as Ge,l as Qe,m as Ye,n as $e,T as We}from"./Layout-DvTybH9z.js";function ne(a,p,g){t.useEffect(()=>(window.addEventListener(a,p,g),()=>window.removeEventListener(a,p,g)),[a,p])}function Xe(a,p="use-local-storage"){try{return JSON.stringify(a)}catch{throw new Error(`@mantine/hooks ${p}: Failed to serialize the value`)}}function Ze(a){try{return a&&JSON.parse(a)}catch{return a}}function et(a){return{getItem:f=>{try{return window[a].getItem(f)}catch{return console.warn("use-local-storage: Failed to get value from storage, localStorage is blocked"),null}},setItem:(f,o)=>{try{window[a].setItem(f,o)}catch{console.warn("use-local-storage: Failed to set value to storage, localStorage is blocked")}},removeItem:f=>{try{window[a].removeItem(f)}catch{console.warn("use-local-storage: Failed to remove value from storage, localStorage is blocked")}}}}function tt(a,p){const g="mantine-local-storage",{getItem:C,setItem:f,removeItem:o}=et(a);return function({key:l,defaultValue:d,getInitialValueInEffect:j=!0,deserialize:w=Ze,serialize:T=i=>Xe(i,p)}){const i=t.useCallback(s=>{let I;try{I=typeof window>"u"||!(a in window)||window[a]===null||!!s}catch{I=!0}if(I)return d;const E=C(l);return E!==null?w(E):d},[l,d]),[b,c]=t.useState(i(j)),h=t.useCallback(s=>{s instanceof Function?c(I=>{const E=s(I);return f(l,T(E)),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:s(I)}})),E}):(f(l,T(s)),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:s}})),c(s))},[l]),v=t.useCallback(()=>{o(l),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:d}}))},[]);return ne("storage",s=>{s.storageArea===window[a]&&s.key===l&&c(w(s.newValue??void 0))}),ne(g,s=>{s.detail.key===l&&c(s.detail.value)}),t.useEffect(()=>{d!==void 0&&b===void 0&&h(d)},[d,b,h]),t.useEffect(()=>{const s=i();s!==void 0&&h(s)},[]),[b===void 0?d:b,h,v]}}function k(a){return tt("localStorage","use-local-storage")(a)}const x=window.localStorage,rt=({children:a})=>{var ee;const[p,g]=t.useState(!1),[C,f]=Ne(void 0,Be),[o,y]=t.useState([]),[l,d]=t.useState([]),j=x.getItem("player-playlist-id"),[w,T]=k({key:"player-playlist-id",defaultValue:j||void 0}),i=x.getItem("player-current-track-index"),b=i?Number(i):u,[c,h]=t.useState(b),[v,s]=t.useState(!1),[I,E]=t.useState(u),[M,_]=k({key:"player-updated-time",defaultValue:0,getInitialValueInEffect:!0}),[V,G]=k({key:"player-volume",defaultValue:Re,getInitialValueInEffect:!0}),[se,ae]=t.useState(je),[oe,B]=t.useState(u),[ue,ce]=t.useState(u),[F,H]=k({key:"player-muted",defaultValue:!1}),[A,O]=k({key:"player-shuffle",defaultValue:!1}),[J,le]=k({key:"player-repeat",defaultValue:P.PlayAll}),[Q,D]=k({key:"player-shuffle-queue",defaultValue:[]}),r=t.useRef(new Audio),L=t.useRef(null),K=t.useCallback((e,n)=>{L.current&&L.current.postMessage({type:e,value:n})},[L.current]);t.useEffect(()=>{K("UPDATE_TRACK",c)},[c]),t.useEffect(()=>{v&&D(A?e=>[c,...e]:[])},[A]),t.useEffect(()=>{const e=Math.round(V*100);ae(e)},[V]),t.useEffect(()=>{if(r.current!==null&&p){const e=r.current.currentTime;Math.abs(e-M)>1&&(r.current.currentTime=M,E(M))}},[M]),t.useEffect(()=>{if(r.current&&o.length>u){const e=o[c];r.current.src=e==null?void 0:e.src,r.current.currentTime=u}},[o,c]),t.useEffect(()=>{if(r.current&&o.length>u){const e=x.getItem("player-current-track-index"),n=e&&Number(e)===c;n||x.setItem("player-current-track-index",String(c)),v?(K("PAUSE_PLAYING"),f(!0),r.current.play().then(()=>{if(r.current&&n){const S=x.getItem("player-sync-time");r.current.currentTime=Number(S)}f(void 0)}).catch(()=>{f(void 0)})):r.current.pause()}},[c,o,v]),t.useEffect(()=>{r.current&&(r.current.volume=V,r.current.muted=F)},[V,F]);const ie=e=>{const n=Array(e.length).fill(0);d(n),e.length>0&&z(e).then(S=>{Array.isArray(S)&&d(S)})},de=e=>{z([e]).then(n=>{n&&d(S=>[...S,n[0]])})},fe=e=>{String(e)!==w&&(h(u),T(e))};t.useEffect(()=>{o.length>0&&z(o).then(e=>{Array.isArray(e)&&d(e)})},[o]);const Y=()=>{if(r.current!==null){const e=r.current.currentTime;E(e),K("UPDATE_TIME",e),x.setItem("player-sync-time",String(e))}},$=t.useCallback(()=>{r.current!==null&&ce(r.current.duration)},[(ee=r.current)==null?void 0:ee.duration]),W=t.useCallback(()=>{o.length!==u&&s(!0)},[o]),X=t.useCallback(()=>s(!1),[s]),me=t.useCallback(()=>s(e=>!e),[s]),R=t.useCallback((e=!1)=>{if(o.length===u)return;let n;if(A){const te=o.map((N,Ae)=>Ae).filter(N=>N!==c);n=te[Math.floor(Math.random()*te.length)],D(N=>(N=N.slice(u,Me),[n,...N]))}else n=c+U;n>=o.length&&(s(e),n=u,!e)||(B(u),v||s(!0),h(n))},[o,c,A,v,h]),q=t.useCallback(()=>{var e;switch(J){case P.PlayAll:R();break;case P.LoopAll:R(!0);break;case P.LoopCue:(e=r.current)==null||e.play();break}},[J,R]),ge=t.useCallback(()=>{if(o.length===u||!r.current)return;if(I>Ve){r.current.currentTime=u;return}let e=u;if(A){if(Q.length===U)return;D(n=>{const[,...S]=n;return e=S[u],S})}else e=c-U;e<u&&(e=o.length-U),h(e),B(u),s(!0)},[o,Q,c,I,_]),he=e=>h(e),pe=e=>G(e),ye=e=>{const n=Ue(e);G(n)},ve=()=>H(!0),Se=()=>H(!1),Pe=()=>H(e=>!e),Ie=()=>O(!0),Ee=()=>O(!1),we=()=>O(e=>!e),be=()=>{le(e=>e===P.PlayAll?P.LoopAll:e===P.LoopAll?P.LoopCue:e===P.LoopCue?P.PlayAll:P.PlayAll)},Te=e=>{y(n=>[...n,e]),de(e)},ke=(e,n)=>{const S=n!==void 0||v;X(),D([u]),B(u),y(e),ie(e),S&&(h(n||u),W())},xe=t.useCallback(e=>{const{data:n}=e;switch(n==null?void 0:n.type){case"PAUSE_PLAYING":s(!1);break;case"UPDATE_TIME":!v&&n.value!==u&&E(n.value);break;case"UPDATE_TRACK":v||h(n.value);break}},[v,h,s,c]),Z=()=>{if(r.current&&r.current.buffered.length>0){const e=r.current.buffered.end(r.current.buffered.length-1);B(e/r.current.duration*100)}};t.useEffect(()=>(r.current&&r.current.addEventListener("ended",q),()=>{var e;(e=r.current)==null||e.removeEventListener("ended",q)}),[q]),t.useEffect(()=>{if(r.current){const e=x.getItem("player-sync-time"),n=Number(e);_(n),r.current.currentTime=n,E(n),s(!1),r.current.preload="metadata",r.current.addEventListener("progress",Z),r.current.addEventListener("timeupdate",Y),r.current.addEventListener("durationchange",$),g(!0)}return"BroadcastChannel"in window&&!L.current&&(L.current=new BroadcastChannel("global-audio-player"),L.current.onmessage=xe),()=>{r.current&&(r.current.pause(),r.current.removeEventListener("progress",Z),r.current.removeEventListener("timeupdate",Y),r.current.removeEventListener("durationchange",$),r.current=null)}},[]);const Ce={play:W,pause:X,togglePlayPause:me,next:R,previous:ge,setVolume:pe,setVolumePercent:ye,mute:ve,unmute:Se,toggleMute:Pe,shuffleOn:Ie,shuffleOff:Ee,toggleShuffle:we,toggleLoop:be,addToPlaylist:Te,replacePlaylist:ke,setCurrentTrack:he,setUpdateTime:_,setPlaylistId:fe,volume:V,volumePercent:se,bufferedPercentage:oe,currentPlaylistId:w,maxTime:ue,playlist:o,durations:l,isPlaying:v,currentTime:I,currentTrackIndex:c,repeatMode:J,isShuffled:A,isLoading:C,isMuted:F};return m.jsx(De.Provider,{value:Ce,children:a})},nt=()=>{const a=_e(),[p,{open:g,close:C}]=Fe(!1),[f,o]=t.useState("preview"),[y,l]=t.useState(Number(a.currentPlaylistId)||1),d=m.jsx(We,{size:18}),j=i=>{fetch(`tracks_${i}.json`).then(b=>b.json()).then(a.replacePlaylist)};t.useEffect(()=>{j(y),a.setPlaylistId(y)},[y]),t.useEffect(()=>{a.currentPlaylistId&&l(Number(a.currentPlaylistId))},[a.currentPlaylistId]);const w=t.useCallback(()=>{let i=y+1;i>3&&(i=1),l(i)},[y]),T=t.useCallback(()=>{let i=y-1;i<1&&(i=3),l(i)},[y]);return He([["alt+ArrowLeft",T],["alt+ArrowRight",w],["mod+Slash",g]]),m.jsx(Oe,{children:m.jsxs(re,{gap:"xs",children:[m.jsxs(re,{children:[m.jsx(Je,{}),m.jsx(Le,{order:2,children:"Full Sync Demo"})]}),m.jsx(Ke,{opened:p,close:C}),f==="preview"?m.jsx(qe,{nextPlaylist:w,prevPlaylist:T}):m.jsx(ze,{code:[{fileName:"main.tsx",code:Ge,language:"tsx",icon:d},{fileName:"App.tsx",code:Qe,language:"tsx",icon:d}]}),m.jsx(Ye,{value:f,onChange:o}),m.jsx($e,{})]})})},ot=()=>m.jsx(rt,{children:m.jsx(nt,{})});export{ot as default};
