import{r as t,j as m,T as Le}from"./index-BCMco0VL.js";import{u as Ne,f as c,d as je,L as P,a as G,t as Me,s as _,o as Ve,P as De,b as Be,c as Re,p as Ue,e as _e,g as Fe,h as He,i as Oe,S as re,B as Je,H as Ke,j as qe,C as ze,k as Ge,l as Qe,m as Ye,n as $e,T as We}from"./Layout-DUmgL2IH.js";function ne(a,p,g){t.useEffect(()=>(window.addEventListener(a,p,g),()=>window.removeEventListener(a,p,g)),[a,p])}function Xe(a,p="use-local-storage"){try{return JSON.stringify(a)}catch{throw new Error(`@mantine/hooks ${p}: Failed to serialize the value`)}}function Ze(a){try{return a&&JSON.parse(a)}catch{return a}}function et(a){return{getItem:f=>{try{return window[a].getItem(f)}catch{return console.warn("use-local-storage: Failed to get value from storage, localStorage is blocked"),null}},setItem:(f,o)=>{try{window[a].setItem(f,o)}catch{console.warn("use-local-storage: Failed to set value to storage, localStorage is blocked")}},removeItem:f=>{try{window[a].removeItem(f)}catch{console.warn("use-local-storage: Failed to remove value from storage, localStorage is blocked")}}}}function tt(a,p){const g="mantine-local-storage",{getItem:A,setItem:f,removeItem:o}=et(a);return function({key:l,defaultValue:d,getInitialValueInEffect:M=!0,deserialize:w=Ze,serialize:T=i=>Xe(i,p)}){const i=t.useCallback(s=>{let I;try{I=typeof window>"u"||!(a in window)||window[a]===null||!!s}catch{I=!0}if(I)return d;const E=A(l);return E!==null?w(E):d},[l,d]),[b,u]=t.useState(i(M)),h=t.useCallback(s=>{s instanceof Function?u(I=>{const E=s(I);return f(l,T(E)),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:s(I)}})),E}):(f(l,T(s)),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:s}})),u(s))},[l]),v=t.useCallback(()=>{o(l),window.dispatchEvent(new CustomEvent(g,{detail:{key:l,value:d}}))},[]);return ne("storage",s=>{s.storageArea===window[a]&&s.key===l&&u(w(s.newValue??void 0))}),ne(g,s=>{s.detail.key===l&&u(s.detail.value)}),t.useEffect(()=>{d!==void 0&&b===void 0&&h(d)},[d,b,h]),t.useEffect(()=>{const s=i();s!==void 0&&h(s)},[]),[b===void 0?d:b,h,v]}}function x(a){return tt("localStorage","use-local-storage")(a)}const C=window.localStorage,rt=({children:a})=>{var te;const[p,g]=t.useState(!1),[A,f]=Ne(void 0,Be),[o,y]=t.useState([]),[l,d]=t.useState([]),M=C.getItem("player-playlist-id"),[w,T]=x({key:"player-playlist-id",defaultValue:M||void 0}),i=C.getItem("player-current-track-index"),b=i?Number(i):c,[u,h]=t.useState(b),[v,s]=t.useState(!1),[I,E]=t.useState(c),[V,F]=x({key:"player-updated-time",defaultValue:0,getInitialValueInEffect:!0}),[D,Q]=x({key:"player-volume",defaultValue:Re,getInitialValueInEffect:!0}),[se,ae]=t.useState(je),[oe,R]=t.useState(c),[ce,ue]=t.useState(c),[H,O]=x({key:"player-muted",defaultValue:!1}),[L,J]=x({key:"player-shuffle",defaultValue:!1}),[K,le]=x({key:"player-repeat",defaultValue:P.PlayAll}),[Y,B]=x({key:"player-shuffle-queue",defaultValue:[]}),r=t.useRef(new Audio),N=t.useRef(null),q=t.useCallback((e,n)=>{N.current&&N.current.postMessage({type:e,value:n})},[N.current]);t.useEffect(()=>{q("UPDATE_TRACK",u)},[u]),t.useEffect(()=>{v&&B(L?e=>[u,...e]:[])},[L]),t.useEffect(()=>{const e=Math.round(D*100);ae(e)},[D]),t.useEffect(()=>{if(r.current!==null&&p){const e=r.current.currentTime;Math.abs(e-V)>1&&(r.current.currentTime=V,E(V))}},[V]),t.useEffect(()=>{if(r.current&&o.length>c){const e=o[u];r.current.src=e==null?void 0:e.src,r.current.currentTime=c}},[o,u]),t.useEffect(()=>{if(r.current&&o.length>c){const e=C.getItem("player-current-track-index"),n=e&&Number(e)===u;n||C.setItem("player-current-track-index",String(u)),v?(q("PAUSE_PLAYING"),f(!0),r.current.play().then(()=>{if(r.current&&n){const S=C.getItem("player-sync-time");r.current.currentTime=Number(S)}f(void 0)}).catch(()=>{f(void 0)})):r.current.pause()}},[u,o,v]),t.useEffect(()=>{r.current&&(r.current.volume=D,r.current.muted=H)},[D,H]);const ie=e=>{const n=Array(e.length).fill(0);if(d(n),e.length>0){const S=e.map(k=>k.src);G(S).then(k=>{Array.isArray(k)&&d(k)})}},de=e=>{G([e.src]).then(n=>{n&&d(S=>[...S,n[0]])})},fe=e=>{String(e)!==w&&(h(c),T(e))};t.useEffect(()=>{if(o.length>0){const e=o.map(n=>n.src);G(e).then(n=>{Array.isArray(n)&&d(n)})}},[o]);const $=()=>{if(r.current!==null){const e=r.current.currentTime;E(e),q("UPDATE_TIME",e),C.setItem("player-sync-time",String(e))}},W=t.useCallback(()=>{r.current!==null&&ue(r.current.duration)},[(te=r.current)==null?void 0:te.duration]),X=t.useCallback(()=>{o.length!==c&&s(!0)},[o]),Z=t.useCallback(()=>s(!1),[s]),me=t.useCallback(()=>s(e=>!e),[s]),U=t.useCallback((e=!1)=>{if(o.length===c)return;let n;if(L){const k=o.map((j,Ae)=>Ae).filter(j=>j!==u);n=k[Math.floor(Math.random()*k.length)],B(j=>(j=j.slice(c,Me),[n,...j]))}else n=u+_;n>=o.length&&(s(e),n=c,!e)||(R(c),v||s(!0),h(n))},[o,u,L,v,h]),z=t.useCallback(()=>{var e;switch(K){case P.PlayAll:U();break;case P.LoopAll:U(!0);break;case P.LoopCue:(e=r.current)==null||e.play();break}},[K,U]),ge=t.useCallback(()=>{if(o.length===c||!r.current)return;if(I>Ve){r.current.currentTime=c;return}let e=c;if(L){if(Y.length===_)return;B(n=>{const[,...S]=n;return e=S[c],S})}else e=u-_;e<c&&(e=o.length-_),h(e),R(c),s(!0)},[o,Y,u,I,F]),he=e=>h(e),pe=e=>Q(e),ye=e=>{const n=Ue(e);Q(n)},ve=()=>O(!0),Se=()=>O(!1),Pe=()=>O(e=>!e),Ie=()=>J(!0),Ee=()=>J(!1),we=()=>J(e=>!e),be=()=>{le(e=>e===P.PlayAll?P.LoopAll:e===P.LoopAll?P.LoopCue:e===P.LoopCue?P.PlayAll:P.PlayAll)},Te=e=>{y(n=>[...n,e]),de(e)},ke=(e,n)=>{const S=n!==void 0||v;Z(),B([c]),R(c),y(e),ie(e),S&&(h(n||c),X())},xe=t.useCallback(e=>{const{data:n}=e;switch(n==null?void 0:n.type){case"PAUSE_PLAYING":s(!1);break;case"UPDATE_TIME":!v&&n.value!==c&&E(n.value);break;case"UPDATE_TRACK":v||h(n.value);break}},[v,h,s,u]),ee=()=>{if(r.current&&r.current.buffered.length>0){const e=r.current.buffered.end(r.current.buffered.length-1);R(e/r.current.duration*100)}};t.useEffect(()=>(r.current&&r.current.addEventListener("ended",z),()=>{var e;(e=r.current)==null||e.removeEventListener("ended",z)}),[z]),t.useEffect(()=>{if(r.current){const e=C.getItem("player-sync-time"),n=Number(e);F(n),r.current.currentTime=n,E(n),s(!1),r.current.preload="metadata",r.current.addEventListener("progress",ee),r.current.addEventListener("timeupdate",$),r.current.addEventListener("durationchange",W),g(!0)}return"BroadcastChannel"in window&&!N.current&&(N.current=new BroadcastChannel("global-audio-player"),N.current.onmessage=xe),()=>{r.current&&(r.current.pause(),r.current.removeEventListener("progress",ee),r.current.removeEventListener("timeupdate",$),r.current.removeEventListener("durationchange",W),r.current=null)}},[]);const Ce={play:X,pause:Z,togglePlayPause:me,next:U,previous:ge,setVolume:pe,setVolumePercent:ye,mute:ve,unmute:Se,toggleMute:Pe,shuffleOn:Ie,shuffleOff:Ee,toggleShuffle:we,toggleLoop:be,addToPlaylist:Te,replacePlaylist:ke,setCurrentTrack:he,setUpdateTime:F,setPlaylistId:fe,volume:D,volumePercent:se,bufferedPercentage:oe,currentPlaylistId:w,maxTime:ce,playlist:o,durations:l,isPlaying:v,currentTime:I,currentTrackIndex:u,repeatMode:K,isShuffled:L,isLoading:A,isMuted:H};return m.jsx(De.Provider,{value:Ce,children:a})},nt=()=>{const a=_e(),[p,{open:g,close:A}]=Fe(!1),[f,o]=t.useState("preview"),[y,l]=t.useState(Number(a.currentPlaylistId)||1),d=m.jsx(We,{size:18}),M=i=>{fetch(`tracks_${i}.json`).then(b=>b.json()).then(a.replacePlaylist)};t.useEffect(()=>{M(y),a.setPlaylistId(y)},[y]),t.useEffect(()=>{a.currentPlaylistId&&l(Number(a.currentPlaylistId))},[a.currentPlaylistId]);const w=t.useCallback(()=>{let i=y+1;i>3&&(i=1),l(i)},[y]),T=t.useCallback(()=>{let i=y-1;i<1&&(i=3),l(i)},[y]);return He([["alt+ArrowLeft",T],["alt+ArrowRight",w],["mod+Slash",g]]),m.jsx(Oe,{children:m.jsxs(re,{gap:"xs",children:[m.jsxs(re,{children:[m.jsx(Je,{}),m.jsx(Le,{order:2,children:"Full Sync Demo"})]}),m.jsx(Ke,{opened:p,close:A}),f==="preview"?m.jsx(qe,{nextPlaylist:w,prevPlaylist:T}):m.jsx(ze,{code:[{fileName:"main.tsx",code:Ge,language:"tsx",icon:d},{fileName:"App.tsx",code:Qe,language:"tsx",icon:d}]}),m.jsx(Ye,{value:f,onChange:o}),m.jsx($e,{})]})})},ot=()=>m.jsx(rt,{children:m.jsx(nt,{})});export{ot as default};
